# CVE-2018-1000544

##### Description
**rubyzip** a gem of Ruby has a vulnerablity with directory and symbolic link traversal when extract a zip file. Using these flaw, a attacker can write a new file in any directory.

These flaw is not related only to Ruby language, we also see on Java, Go, Javascript 
https://snyk.io/research/zip-slip-vulnerability

  - Impact: Moderate 
    - moderate impact since **rubyzip** is not a necessary gem for proper operation of the operating system. 

##### How works?
  The vulnerability is exploited using a specially crafted archive that holds directory traversal filenames (e.g. ../../dangerous_file.sh). These vulnerability can affect numerous archive formats, including tar, jar, cpio, apk, rar and 7z. **Not only zip files**. And a extraction code, that does not make any validation checking.
  
  For test we can use these files (https://github.com/tuzovakaoff/zip_path_traversal), created by tuzovakaoff.. these zip file contais a file named `/etc/file.txt`, when extracted in vulnarable enviroment, goes to the absolute path (/etc/file.txt). 
  
  #### Ruby Enviroment: 
  ```sh
  $ ruby -v
ruby 2.6.0p0 (2018-12-25 revision 66547) [x86_64-darwin16]
$ gem list | grep zip
rubyzip (1.2.1)
```
**Vulnarable code:**

  ```ruby
  require 'zip'

def check__extract()
    path = '/tmp/file.txt'
    File.delete(path) if File.exist?(path)
    Zip::File.open('./absolutepath.zip') do |zip_file|
      zip_file.each do |entry|
        entry.extract
      end
    end
    if File.exist?(path)
        puts "[Absolute path] Vulnerable! rubyzip can extract to absolute path"
    else
        puts "[Absolute path] Not vulnerable! :)"
    end
end

extract()
  ```
**How to fix?**
- If you **do not want** to change *rubyzip*  code, you can simple check the file before extract, like these:
```ruby
require 'zip'
require 'pathname'

def check_extract()
    path = '/tmp/file.txt'
    File.delete(path) if File.exist?(path)
    Zip::File.open('./absolutepath.zip') do |zip_file|
      zip_file.each do |entry|
        if  Pathname.new(entry.name).absolute?
            puts "WARNING: skipped absolute path in #{entry.name}"
            return self
        elsif entry.name.squeeze('/') =~ /\.{2}(?:\/|\z)/
            puts "WARNING: skipped \"../\" path component(s) in #{entry.name}"
            return self
        end
        entry.extract
      end
    end
    
    if File.exist?(path)
        puts "[Absolute path] Vulnerable! rubyzip can extract to absolute path"
    else
        puts "[Absolute path] Not vulnerable! :)"
    end
end

check_extract()
```
- or if you want to fix directly on rubyzip gem, follow these steps:
-- Open `entry.drb` file, inside `lib` folder on gem installed path
-- Line 150, on `extract` method, change to these **before** `block` line:
```ruby
      if Pathname.new(@name).absolute?
        puts "skipped absolute path in #{@name}"
        return self
      elsif @name.squeeze('/') =~ /\.{2}(?:\/|\z)/
        puts "skipped \"../\" path component(s) in #{@name}"
        return self
      elsif get_input_stream.read =~ %r{../..}
        puts "skipped \"#{get_input_stream.read}\" symlink path in #{@name}"
        return self
      end
      block ||= proc { ::Zip.on_exists_proc }
```

#### Java Enviroment:
Example how to exploit these vulnarabiliy on Java code..

**Example Vulnerable Code:**
```java
   Enumeration<ZipEntry> files = zip.getEntries();
   while (zip_files.hasMoreElements()) {
      ZipEntry e = zip_files.nextElement();
      File f = new File(destinationDir, e.getName());
      InputStream input = zip.getInputStream(e);
      IOUtils.copy(input, write(f));
   }
```
**How to fix?**
Just include a verification befora extract
```java
   Enumeration<ZipEntry> files = zip.getEntries();
   while (zip_files.hasMoreElements()) {
      ZipEntry e = zip_files.nextElement();
      String canonical_dest_DirPath = destinationDir.getCanonicalPath();
      File dest_file = new File(destinationDir, e.getName());
      String canonical_dest_File = dest_file.getCanonicalPath();
      if (!canonical_dest_File.startsWith(canonical_dest_DirPath + File.separator)) {
            throw new ArchiverException("Skipped path problem on dir: " + e.getName());
      }
      File f = new File(destinationDir, e.getName());
      InputStream input = zip.getInputStream(e);
      IOUtils.copy(input, write(f));
   }
```

## Conclusion

Beside these CVE is about RubyZip gem, these vulnarability is not present only on ruby, it's present in most advanced language (Go, Java, Javascript, Ruby). And it's related to the  **Zip Slip Vulnerability** and it's present in several project, like Apache, ElasticSearch and others.

The flaw is not verify the path before extract. the premise of these  vulnerability is that an attacker can gain access to parts of the file system outside of the target folder in which they should reside. The attacker can then overwrite executable files and either invoke them remotely or wait for the system or user to call them, thus achieving remote command execution on the victimâ€™s machine. 

The vulnerability can also cause damage by overwriting configuration files or other sensitive resources, and can be exploited on both client (user) machines and servers.



Research from:
- https://access.redhat.com/security/cve/cve-2018-1000544
- https://bugzilla.redhat.com/show_bug.cgi?id=1593001
- https://snyk.io/research/zip-slip-vulnerability
- http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000544
- https://github.com/rubyzip/rubyzip/issues/369
- https://github.com/snyk/zip-slip-vulnerability




